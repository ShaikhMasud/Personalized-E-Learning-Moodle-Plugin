{"version":3,"file":"chat_assistant.min.js","sources":["../src/chat_assistant.js"],"sourcesContent":["// amd/src/chat_assistant.js\r\ndefine(['jquery'], function($) {\r\n    'use strict';\r\n\r\n    let pendingCoursePayload = null; // last course params returned by assistant\r\n    let awaitingConfirmation = false; // true while confirmation UI is active\r\n\r\n    function reset() {\r\n        pendingCoursePayload = null;\r\n        awaitingConfirmation = false;\r\n    }\r\n\r\n    /**\r\n     * Allows the assistant mode to modify the prompt before sending.\r\n     * Used for \"edit\" flow: turns a user edit into a structured wrapper prompt.\r\n     */\r\n    function beforeSend(text) {\r\n        if (pendingCoursePayload && awaitingConfirmation) {\r\n            const wrapper = [\r\n                'You are updating an existing COURSE CREATION JSON.',\r\n                'Strict rules:',\r\n                '- You MUST respond with a single JSON object, no explanations.',\r\n                '- \"type\" MUST be exactly \"course_creation\" (do NOT invent new types).',\r\n                '- Preserve existing fields unless the user explicitly changes them.',\r\n                '- Keep the same number of sections (same array length).',\r\n                '- Only modify the specific sections or fields the user mentions.',\r\n                '- When the user gives new section names, COPY THEM VERBATIM.',\r\n                '- Do not change spelling, singular/plural, or wording of section names.',\r\n                '',\r\n                'PREVIOUS_PARAMS:',\r\n                JSON.stringify(pendingCoursePayload),\r\n                '',\r\n                'USER_EDIT:',\r\n                text\r\n            ].join('\\n');\r\n\r\n            return wrapper;\r\n        }\r\n\r\n        return text;\r\n    }\r\n\r\n    /**\r\n     * Handle Groq/Moodle automation responses for assistant mode.\r\n     * ui helpers: { appendMessage, scrollMessagesToBottom, showConfirmButton, clearConfirmButton, escapeHtml }\r\n     *\r\n     * Must return:\r\n     *   true  -> response fully handled, shell should NOT do fallback handling\r\n     *   false -> shell will handle (plain text / other modes)\r\n     */\r\n    function handleResponse(res, ui) {\r\n        if (!(res && res.automation && res.data)) {\r\n            // Not an automation payload – let shell handle it\r\n            return false;\r\n        }\r\n\r\n        const data = res.data;\r\n\r\n        // --- Missing params case ---\r\n        if (data.type === 'course_creation_missing_params') {\r\n            const missing = data.missing || [];\r\n            ui.appendMessage(\r\n                '<div><b>Missing parameters:</b> ' + ui.escapeHtml(missing.join(', ')) + '</div>',\r\n                'bot'\r\n            );\r\n            reset();\r\n            ui.clearConfirmButton();\r\n            return true;\r\n        }\r\n\r\n        // --- Course creation / update case ---\r\n        if (data.type === 'course_creation' || data.type === 'course_update') {\r\n            const params = data.params || {};\r\n            const category = params.category || 1;\r\n\r\n            // Resolve numsections\r\n            let numsections = parseInt(params.numsections, 10);\r\n            if (isNaN(numsections) || numsections <= 0) {\r\n                numsections = Array.isArray(params.sections) ? params.sections.length : 0;\r\n            }\r\n\r\n            const rawSections = Array.isArray(params.sections) ? params.sections : [];\r\n            let sections = rawSections.map((s, idx) => {\r\n                if (typeof s === 'string') {\r\n                    return s;\r\n                }\r\n                if (s && typeof s === 'object') {\r\n                    return s.name || s.title || ('Section ' + (idx + 1));\r\n                }\r\n                return 'Section ' + (idx + 1);\r\n            });\r\n\r\n            // Pad to numsections\r\n            if (numsections > sections.length) {\r\n                const start = sections.length;\r\n                for (let i = start; i < numsections; i++) {\r\n                    sections.push('Section ' + (i + 1));\r\n                }\r\n            }\r\n\r\n            // Trim if too many\r\n            if (numsections > 0 && sections.length > numsections) {\r\n                sections = sections.slice(0, numsections);\r\n            }\r\n\r\n            // Shortname fallback\r\n            let shortname = params.shortname || '';\r\n            if (!shortname && params.fullname) {\r\n                shortname = params.fullname.replace(/\\s+/g, '').toUpperCase().slice(0, 15);\r\n            }\r\n\r\n            // Store payload for confirmation/edit flow\r\n            pendingCoursePayload = {\r\n                fullname: params.fullname || '',\r\n                shortname: shortname,\r\n                category: category,\r\n                sections: sections\r\n            };\r\n            awaitingConfirmation = true;\r\n\r\n            // Show preview\r\n            const html = `\r\n                <div class=\"automation-box\">\r\n                    <b>Course Preview</b><br>\r\n                    Fullname: ${ui.escapeHtml(pendingCoursePayload.fullname)}<br>\r\n                    Shortname: ${ui.escapeHtml(pendingCoursePayload.shortname)}<br>\r\n                    Category: ${ui.escapeHtml(String(pendingCoursePayload.category))}<br>\r\n                    Sections: ${ui.escapeHtml(pendingCoursePayload.sections.join(', '))}<br>\r\n                </div>\r\n            `;\r\n            ui.appendMessage(html, 'bot');\r\n\r\n            // Show confirm button below chat\r\n            ui.showConfirmButton(function() {\r\n                if (!pendingCoursePayload) {\r\n                    ui.appendMessage('⚠️ No course data to confirm.', 'bot');\r\n                    return;\r\n                }\r\n\r\n                console.log(\r\n                    'JS DEBUG: Sending request to:',\r\n                    M.cfg.wwwroot + '/local/automation/course_ajax.php'\r\n                );\r\n                console.log('JS DEBUG: Payload being sent:', {\r\n                    ...pendingCoursePayload,\r\n                    sesskey: M.cfg.sesskey\r\n                });\r\n\r\n                $.ajax({\r\n                    url: M.cfg.wwwroot + '/local/automation/course_ajax.php',\r\n                    method: 'POST',\r\n                    data: JSON.stringify({\r\n                        ...pendingCoursePayload,\r\n                        sesskey: M.cfg.sesskey\r\n                    }),\r\n                    contentType: 'application/json',\r\n                    dataType: 'json',\r\n                    success: function(response) {\r\n                        console.log('Server response:', response);\r\n                        if (response && response.success) {\r\n                            ui.appendMessage(\r\n                                `✅ Course created! ID: ${ui.escapeHtml(String(response.courseid))}`,\r\n                                'bot'\r\n                            );\r\n                            reset();\r\n                            ui.clearConfirmButton();\r\n                        } else {\r\n                            ui.appendMessage(\r\n                                '❌ Error: ' + (response.error || 'Unknown error'),\r\n                                'bot'\r\n                            );\r\n                        }\r\n                    },\r\n                    error: function(xhr) {\r\n                        ui.appendMessage('❌ Failed to create course. See server logs.', 'bot');\r\n                        console.error('AJAX error (course_ajax):', xhr);\r\n                    }\r\n                });\r\n            });\r\n\r\n            ui.scrollMessagesToBottom();\r\n            return true;\r\n        }\r\n\r\n        // Unknown automation type -> let shell show raw content if needed\r\n        return false;\r\n    }\r\n\r\n    return {\r\n        beforeSend: beforeSend,\r\n        handleResponse: handleResponse,\r\n        reset: reset\r\n    };\r\n});\r\n"],"names":["define","$","pendingCoursePayload","awaitingConfirmation","reset","beforeSend","text","JSON","stringify","join","handleResponse","res","ui","automation","data","type","missing","appendMessage","escapeHtml","clearConfirmButton","params","category","numsections","parseInt","isNaN","Array","isArray","sections","length","map","s","idx","name","title","i","push","slice","shortname","fullname","replace","toUpperCase","html","String","showConfirmButton","console","log","M","cfg","wwwroot","sesskey","ajax","url","method","contentType","dataType","success","response","courseid","error","xhr","scrollMessagesToBottom"],"mappings":"AACAA,yCAAO,CAAC,WAAW,SAASC,OAGpBC,qBAAuB,KACvBC,sBAAuB,WAElBC,QACLF,qBAAuB,KACvBC,sBAAuB,QAmLpB,CACHE,oBA7KgBC,SACZJ,sBAAwBC,qBAAsB,OAC9B,CACZ,qDACA,gBACA,iEACA,wEACA,sEACA,0DACA,mEACA,+DACA,0EACA,GACA,mBACAI,KAAKC,UAAUN,sBACf,GACA,aACAI,MACFG,KAAK,aAKJH,MAuJPI,wBA5IoBC,IAAKC,SACnBD,KAAOA,IAAIE,YAAcF,IAAIG,aAExB,QAGLA,KAAOH,IAAIG,QAGC,mCAAdA,KAAKC,KAA2C,OAC1CC,QAAUF,KAAKE,SAAW,UAChCJ,GAAGK,cACC,mCAAqCL,GAAGM,WAAWF,QAAQP,KAAK,OAAS,SACzE,OAEJL,QACAQ,GAAGO,sBACI,KAIO,oBAAdL,KAAKC,MAA4C,kBAAdD,KAAKC,KAA0B,OAC5DK,OAASN,KAAKM,QAAU,GACxBC,SAAWD,OAAOC,UAAY,MAGhCC,YAAcC,SAASH,OAAOE,YAAa,KAC3CE,MAAMF,cAAgBA,aAAe,KACrCA,YAAcG,MAAMC,QAAQN,OAAOO,UAAYP,OAAOO,SAASC,OAAS,OAIxED,UADgBF,MAAMC,QAAQN,OAAOO,UAAYP,OAAOO,SAAW,IAC5CE,KAAI,CAACC,EAAGC,MACd,iBAAND,EACAA,EAEPA,GAAkB,iBAANA,IACLA,EAAEE,MAAQF,EAAEG,QAEhB,YAAcF,IAAM,QAI3BT,YAAcK,SAASC,OAAQ,KAE1B,IAAIM,EADKP,SAASC,OACHM,EAAIZ,YAAaY,IACjCP,SAASQ,KAAK,YAAcD,EAAI,IAKpCZ,YAAc,GAAKK,SAASC,OAASN,cACrCK,SAAWA,SAASS,MAAM,EAAGd,kBAI7Be,UAAYjB,OAAOiB,WAAa,IAC/BA,WAAajB,OAAOkB,WACrBD,UAAYjB,OAAOkB,SAASC,QAAQ,OAAQ,IAAIC,cAAcJ,MAAM,EAAG,KAI3ElC,qBAAuB,CACnBoC,SAAUlB,OAAOkB,UAAY,GAC7BD,UAAWA,UACXhB,SAAUA,SACVM,SAAUA,UAEdxB,sBAAuB,QAGjBsC,4IAGc7B,GAAGM,WAAWhB,qBAAqBoC,0DAClC1B,GAAGM,WAAWhB,qBAAqBmC,0DACpCzB,GAAGM,WAAWwB,OAAOxC,qBAAqBmB,0DAC1CT,GAAGM,WAAWhB,qBAAqByB,SAASlB,KAAK,4DAGrEG,GAAGK,cAAcwB,KAAM,OAGvB7B,GAAG+B,mBAAkB,WACZzC,sBAKL0C,QAAQC,IACJ,gCACAC,EAAEC,IAAIC,QAAU,qCAEpBJ,QAAQC,IAAI,gCAAiC,IACtC3C,qBACH+C,QAASH,EAAEC,IAAIE,UAGnBhD,EAAEiD,KAAK,CACHC,IAAKL,EAAEC,IAAIC,QAAU,oCACrBI,OAAQ,OACRtC,KAAMP,KAAKC,UAAU,IACdN,qBACH+C,QAASH,EAAEC,IAAIE,UAEnBI,YAAa,mBACbC,SAAU,OACVC,QAAS,SAASC,UACdZ,QAAQC,IAAI,mBAAoBW,UAC5BA,UAAYA,SAASD,SACrB3C,GAAGK,8CAC0BL,GAAGM,WAAWwB,OAAOc,SAASC,YACvD,OAEJrD,QACAQ,GAAGO,sBAEHP,GAAGK,cACC,aAAeuC,SAASE,OAAS,iBACjC,QAIZA,MAAO,SAASC,KACZ/C,GAAGK,cAAc,8CAA+C,OAChE2B,QAAQc,MAAM,4BAA6BC,SAxC/C/C,GAAGK,cAAc,gCAAiC,UA6C1DL,GAAGgD,0BACI,SAIJ,GAMPxD,MAAOA"}