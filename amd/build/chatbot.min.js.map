{"version":3,"file":"chatbot.min.js","sources":["../src/chatbot.js"],"sourcesContent":["// amd/src/chatbot.js\r\ndefine([\r\n    'jquery',\r\n    'core/templates',\r\n    'local_automation/chat_assistant',\r\n    'local_automation/chat_qb',\r\n    'local_automation/chat_quiz'\r\n], function($, Templates, Assistant, QB, Quiz) {\r\n    'use strict';\r\n\r\n    const STORAGE_PREFIX = 'ai_chat_history_';\r\n    let currentMode = 'assistant'; // Default mode\r\n\r\n    // Mode-specific handlers (only assistant for now)\r\n    const handlers = {\r\n        assistant: Assistant,\r\n        qb: QB,\r\n        quiz: Quiz\r\n    };\r\n\r\n    // ===== History helpers =====\r\n    function getStorageKey() {\r\n        return STORAGE_PREFIX + currentMode;\r\n    }\r\n\r\n    function loadHistory() {\r\n        $('#chatbot-messages').empty();\r\n\r\n        let history = localStorage.getItem(getStorageKey());\r\n        if (!history) {\r\n            return;\r\n        }\r\n        history = JSON.parse(history);\r\n\r\n        history.forEach(msg => appendMessage(msg.text, msg.sender, false));\r\n        scrollMessagesToBottom();\r\n    }\r\n\r\n    function saveMessage(text, sender) {\r\n        let history = localStorage.getItem(getStorageKey());\r\n        history = history ? JSON.parse(history) : [];\r\n        history.push({ text, sender });\r\n        localStorage.setItem(getStorageKey(), JSON.stringify(history));\r\n    }\r\n\r\n    // ===== UI helpers =====\r\n    function appendMessage(text, sender, store = true) {\r\n        const className = sender === 'user' ? 'msg-user' : 'msg-bot';\r\n        $('#chatbot-messages').append(`<div class=\"message ${className}\">${text}</div>`);\r\n\r\n        if (store) {\r\n            saveMessage(text, sender);\r\n        }\r\n        scrollMessagesToBottom();\r\n    }\r\n\r\n    function scrollMessagesToBottom() {\r\n        const msgBox = $('#chatbot-messages')[0];\r\n        if (msgBox) {\r\n            msgBox.scrollTo({ top: msgBox.scrollHeight, behavior: 'smooth' });\r\n        }\r\n    }\r\n\r\n    // helper to escape HTML to avoid XSS with user-editable data\r\n    function escapeHtml(str) {\r\n        if (str === null || str === undefined) return '';\r\n        return String(str)\r\n            .replace(/&/g, '&amp;')\r\n            .replace(/</g, '&lt;')\r\n            .replace(/>/g, '&gt;')\r\n            .replace(/\"/g, '&quot;')\r\n            .replace(/'/g, '&#039;');\r\n    }\r\n\r\n    // ===== Confirm button area (used by assistant handler) =====\r\n    function showConfirmButton(onConfirm) {\r\n        const area = $('#chatbot-action-area');\r\n\r\n        area.html(`\r\n            <div id=\"chatbot-edit-note\">Type for any edits...</div>\r\n            <button id=\"chatbot-confirm-btn\">Confirm</button>\r\n        `);\r\n\r\n        $('#chatbot-confirm-btn').off('click').on('click', onConfirm);\r\n    }\r\n\r\n    function clearConfirmButton() {\r\n        $('#chatbot-action-area').empty();\r\n    }\r\n\r\n    // ===== Core send logic =====\r\n    function handleSend() {\r\n        const input = $('#chatbot-input');\r\n        const text = input.val().trim();\r\n        if (!text) {\r\n            return;\r\n        }\r\n\r\n        appendMessage(escapeHtml(text), 'user');\r\n        input.val('');\r\n\r\n        // Allow mode-specific handler to transform the prompt (e.g., assistant edit flow)\r\n        let promptToSend = text;\r\n        const handler = handlers[currentMode];\r\n        if (handler && typeof handler.beforeSend === 'function') {\r\n            promptToSend = handler.beforeSend(text);\r\n        }\r\n\r\n        $.ajax({\r\n            url: M.cfg.wwwroot + '/local/automation/chatbot_endpoint.php',\r\n            method: 'POST',\r\n            data: {\r\n                prompt: promptToSend,\r\n                mode: currentMode,\r\n                sesskey: M.cfg.sesskey\r\n            },\r\n            success: function(res) {\r\n                // Give mode handler a first chance to process structured automation responses\r\n                const handler = handlers[currentMode];\r\n                if (handler && typeof handler.handleResponse === 'function') {\r\n                    const consumed = handler.handleResponse(res, {\r\n                        appendMessage,\r\n                        scrollMessagesToBottom,\r\n                        showConfirmButton,\r\n                        clearConfirmButton,\r\n                        escapeHtml\r\n                    });\r\n\r\n                    if (consumed) {\r\n                        return;\r\n                    }\r\n                }\r\n\r\n                // Fallback plain-text handling (for qb / quiz / generic assistant replies)\r\n                if (res.reply) {\r\n                    const formattedReply = res.reply.replace(/\\n/g, '<br>');\r\n                    appendMessage(formattedReply, 'bot');\r\n                } else {\r\n                    appendMessage('⚠️ ' + (res.error || 'No response from AI'), 'bot');\r\n                }\r\n            },\r\n            error: function(xhr) {\r\n                appendMessage('❌ Failed to connect to server.', 'bot');\r\n                console.error(xhr);\r\n            }\r\n        });\r\n    }\r\n\r\n    // ===== Tab switching =====\r\n    function handleTabSwitch(newMode) {\r\n        if (newMode === currentMode) {\r\n            return;\r\n        }\r\n\r\n        // Reset previous mode handler (if any state)\r\n        const oldHandler = handlers[currentMode];\r\n        if (oldHandler && typeof oldHandler.reset === 'function') {\r\n            oldHandler.reset();\r\n        }\r\n\r\n        currentMode = newMode;\r\n        console.log(`Switched to mode: ${currentMode}`);\r\n\r\n        // Update tab visuals\r\n        $('.chat-tab').removeClass('active');\r\n        $(`.chat-tab[data-mode=\"${currentMode}\"]`).addClass('active');\r\n\r\n        // Update header title\r\n        const headerText = {\r\n            assistant: 'AI Assistant',\r\n            qb: 'QB Generator',\r\n            quiz: 'Quiz Generator'\r\n        }[currentMode];\r\n        $('.chat-header span').text(headerText);\r\n\r\n        clearConfirmButton();\r\n        loadHistory();\r\n    }\r\n\r\n    // ===== Event binding =====\r\n    function bindEvents() {\r\n        $('#ai-chatbot-button').on('click', () => {\r\n            $('#ai-chatbot-modal').toggleClass('hidden');\r\n            $('#chatbot-input').focus();\r\n        });\r\n\r\n        $('#chatbot-close-btn').on('click', () => {\r\n            $('#ai-chatbot-modal').addClass('hidden');\r\n        });\r\n\r\n        $('#chatbot-send-btn').on('click', handleSend);\r\n\r\n        $('#chatbot-input').on('keypress', function(e) {\r\n            if (e.key === 'Enter') {\r\n                e.preventDefault();\r\n                handleSend();\r\n            }\r\n        });\r\n\r\n        $('.chat-tab').on('click', function() {\r\n            const mode = $(this).data('mode');\r\n            handleTabSwitch(mode);\r\n        });\r\n    }\r\n\r\n    // ===== Init =====\r\n    function init() {\r\n        if (!document.getElementById('chatbot-style')) {\r\n            $('head').append(\r\n                '<link id=\"chatbot-style\" rel=\"stylesheet\" href=\"' +\r\n                M.cfg.wwwroot +\r\n                '/local/automation/style/chatbot.css\">'\r\n            );\r\n        }\r\n\r\n        Templates.render('local_automation/chatbot', {})\r\n            .then(html => {\r\n                $('body').append(html);\r\n                bindEvents();\r\n                loadHistory();\r\n            })\r\n            .catch(err => console.error('Chatbot template load failed:', err));\r\n    }\r\n\r\n    return { init: init };\r\n});\r\n"],"names":["define","$","Templates","Assistant","QB","Quiz","currentMode","handlers","assistant","qb","quiz","getStorageKey","loadHistory","empty","history","localStorage","getItem","JSON","parse","forEach","msg","appendMessage","text","sender","scrollMessagesToBottom","saveMessage","push","setItem","stringify","store","className","append","msgBox","scrollTo","top","scrollHeight","behavior","escapeHtml","str","String","replace","showConfirmButton","onConfirm","html","off","on","clearConfirmButton","handleSend","input","val","trim","promptToSend","handler","beforeSend","ajax","url","M","cfg","wwwroot","method","data","prompt","mode","sesskey","success","res","handleResponse","reply","error","xhr","console","bindEvents","toggleClass","focus","addClass","e","key","preventDefault","newMode","oldHandler","reset","log","removeClass","headerText","handleTabSwitch","this","init","document","getElementById","render","then","catch","err"],"mappings":"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"}