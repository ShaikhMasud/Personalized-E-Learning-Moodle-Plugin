{"version":3,"file":"chatbot.min.js","sources":["../src/chatbot.js"],"sourcesContent":["define(['jquery', 'core/templates'], function($, Templates) {\r\n    'use strict';\r\n\r\n    const STORAGE_PREFIX = 'ai_chat_history_';\r\n    let currentMode = 'assistant'; // Default mode\r\n\r\n    // For course creation flow\r\n    let pendingCoursePayload = null;      // holds last course params returned by assistant\r\n    let awaitingConfirmation = false;     // true when a confirmation bubble is shown\r\n\r\n    function getStorageKey() {\r\n        return STORAGE_PREFIX + currentMode;\r\n    }\r\n\r\n    function loadHistory() {\r\n        $('#chatbot-messages').empty();\r\n\r\n        let history = localStorage.getItem(getStorageKey());\r\n        if (!history) return;\r\n        history = JSON.parse(history);\r\n\r\n        history.forEach(msg => appendMessage(msg.text, msg.sender, false));\r\n        scrollMessagesToBottom();\r\n    }\r\n\r\n    function saveMessage(text, sender) {\r\n        let history = localStorage.getItem(getStorageKey());\r\n        history = history ? JSON.parse(history) : [];\r\n        history.push({ text, sender });\r\n        localStorage.setItem(getStorageKey(), JSON.stringify(history));\r\n    }\r\n\r\n    function appendMessage(text, sender, store = true) {\r\n        const className = sender === 'user' ? 'msg-user' : 'msg-bot';\r\n        $('#chatbot-messages').append(`<div class=\"message ${className}\">${text}</div>`);\r\n\r\n        if (store) saveMessage(text, sender);\r\n        scrollMessagesToBottom();\r\n    }\r\n\r\n    function scrollMessagesToBottom() {\r\n        const msgBox = $('#chatbot-messages')[0];\r\n        if (msgBox) {\r\n            msgBox.scrollTo({ top: msgBox.scrollHeight, behavior: 'smooth' });\r\n        }\r\n    }\r\n    // Renders automation JSON responses (assistant mode)\r\n    function renderAutomationMessage(data) {\r\n        // missing params -> list them and ask the user to provide\r\n        if (data.type === 'course_creation_missing_params') {\r\n            const missing = data.missing || [];\r\n            appendMessage(`<div><b>Missing parameters:</b> ${missing.join(', ')}</div>`, 'bot');\r\n            // clear any pending flow (user must provide missing details)\r\n            pendingCoursePayload = null;\r\n            awaitingConfirmation = false;\r\n            return;\r\n        }\r\n\r\n        if (data.type === 'course_creation'|| data.type === 'course_update') {\r\n            const params = data.params || {};\r\n            const category = params.category || 1;\r\n\r\n            // numsections from model (preferred), fallback to sections length\r\n            let numsections = parseInt(params.numsections, 10);\r\n            if (isNaN(numsections) || numsections <= 0) {\r\n                numsections = Array.isArray(params.sections) ? params.sections.length : 0;\r\n            }\r\n\r\n            const rawSections = Array.isArray(params.sections) ? params.sections : [];\r\n            let sections = rawSections.map((s, idx) => {\r\n                if (typeof s === 'string') {\r\n                    return s;\r\n                }\r\n                if (s && typeof s === 'object') {\r\n                    // If Groq returns { \"name\": \"Graphs\" } or { \"title\": \"Graphs\" }\r\n                    return s.name || s.title || ('Section ' + (idx + 1));\r\n                }\r\n                return 'Section ' + (idx + 1);\r\n            });\r\n\r\n            // If LLM returned fewer section names than numsections, pad the rest\r\n            if (numsections > sections.length) {\r\n                const start = sections.length;\r\n                for (let i = start; i < numsections; i++) {\r\n                    sections.push('Section ' + (i + 1));\r\n                }\r\n            }\r\n        \r\n            // If numsections somehow smaller, trim to be safe\r\n            if (numsections > 0 && sections.length > numsections) {\r\n                sections = sections.slice(0, numsections);\r\n            }\r\n\r\n            let shortname = params.shortname || '';\r\n            if (!shortname && params.fullname) {\r\n                shortname = params.fullname.replace(/\\s+/g, '').toUpperCase().slice(0, 15);\r\n            }\r\n\r\n\r\n            // store pending payload\r\n            pendingCoursePayload = {\r\n                fullname: params.fullname || '',\r\n                shortname: params.shortname || '',\r\n                category: category,\r\n                sections: sections\r\n            };\r\n            awaitingConfirmation = true;\r\n        \r\n            // show preview bubble\r\n            const html = `\r\n                <div class=\"automation-box\">\r\n                    <b>Course Preview</b><br>\r\n                    Fullname: ${escapeHtml(pendingCoursePayload.fullname)}<br>\r\n                    Shortname: ${escapeHtml(pendingCoursePayload.shortname)}<br>\r\n                    Category: ${escapeHtml(pendingCoursePayload.category)}<br>\r\n                    Sections: ${escapeHtml(pendingCoursePayload.sections.join(', '))}<br>\r\n                </div>\r\n            `;\r\n            appendMessage(html, 'bot');\r\n        \r\n            // show confirm button *below chat* using action-area\r\n            showConfirmButton(function() {\r\n                console.log(\"JS DEBUG: Sending request to:\", M.cfg.wwwroot + '/local/automation/course_ajax.php');\r\n                console.log(\"JS DEBUG: Payload being sent:\", {\r\n                    ...pendingCoursePayload,\r\n                    sesskey: M.cfg.sesskey\r\n                });\r\n            \r\n                // send to backend\r\n                $.ajax({\r\n                    url: M.cfg.wwwroot + '/local/automation/course_ajax.php',\r\n                    method: 'POST',\r\n                    data: JSON.stringify({\r\n                        ...pendingCoursePayload,\r\n                        sesskey: M.cfg.sesskey\r\n                    }),\r\n                    contentType: \"application/json\",\r\n                    dataType: \"json\",\r\n                    success: function(res) {\r\n                        console.log(\"Server response:\", res);\r\n                        if (res && res.success) {\r\n                            appendMessage(`✅ Course created! ID: ${res.courseid}`, 'bot');\r\n                            pendingCoursePayload = null;\r\n                            awaitingConfirmation = false;\r\n                            clearConfirmButton();\r\n                        } else {\r\n                            appendMessage('❌ Error: ' + (res.error || 'Unknown error'), 'bot');\r\n                        }\r\n                    },\r\n                    error: function(xhr) {\r\n                        appendMessage('❌ Failed to create course. See server logs.', 'bot');\r\n                        console.error(\"AJAX error:\", xhr);\r\n                    }\r\n                });\r\n            \r\n            });\r\n        \r\n            scrollMessagesToBottom();\r\n            return;\r\n        }\r\n\r\n        // Unknown automation type -> just show raw JSON\r\n        appendMessage(`<pre>${escapeHtml(JSON.stringify(data, null, 2))}</pre>`, 'bot');\r\n    }\r\n\r\n    // helper to escape HTML to avoid XSS with user-editable data\r\n    function escapeHtml(str) {\r\n        if (str === null || str === undefined) return '';\r\n        return String(str)\r\n            .replace(/&/g, '&amp;')\r\n            .replace(/</g, '&lt;')\r\n            .replace(/>/g, '&gt;')\r\n            .replace(/\"/g, '&quot;')\r\n            .replace(/'/g, '&#039;');\r\n    }\r\n\r\n    // Show confirm button only for automation confirmation\r\n    function showConfirmButton(onConfirm) {\r\n        const area = $('#chatbot-action-area');\r\n\r\n        area.html(`\r\n            <div id=\"chatbot-edit-note\">Type for any edits...</div>\r\n            <button id=\"chatbot-confirm-btn\">Confirm</button>\r\n        `);\r\n\r\n        $('#chatbot-confirm-btn').off('click').on('click', onConfirm);\r\n    }\r\n\r\n    function clearConfirmButton() {\r\n        $('#chatbot-action-area').empty();\r\n    }\r\n\r\n    function handleSend() {\r\n        const input = $('#chatbot-input');\r\n        const text = input.val().trim();\r\n        if (!text) return;\r\n\r\n        appendMessage(text, 'user');\r\n        input.val('');\r\n\r\n        // If we are awaiting confirmation (a pending course preview exists),\r\n        // treat the user's message as an edit instruction.\r\n        let promptToSend = text;\r\n        if (pendingCoursePayload && awaitingConfirmation) {\r\n            const wrapper = [\r\n                \"You are updating an existing COURSE CREATION JSON.\",\r\n                \"Strict rules:\",\r\n                \"- You MUST respond with a single JSON object, no explanations.\",\r\n                \"- \\\"type\\\" MUST be exactly \\\"course_creation\\\" (do NOT invent new types).\",\r\n                \"- Preserve existing fields unless the user explicitly changes them.\",\r\n                \"- Keep the same number of sections (same array length).\",\r\n                \"- Only modify the specific sections or fields the user mentions.\",\r\n                \"\",\r\n                \"PREVIOUS_PARAMS:\",\r\n                JSON.stringify(pendingCoursePayload),\r\n                \"\",\r\n                \"USER_EDIT:\",\r\n                text\r\n            ].join('\\n');\r\n            promptToSend = wrapper;\r\n        }\r\n\r\n        $.ajax({\r\n            url: M.cfg.wwwroot + '/local/automation/chatbot_endpoint.php',\r\n            method: 'POST',\r\n            data: {\r\n                prompt: promptToSend,\r\n                mode: currentMode,\r\n                sesskey: M.cfg.sesskey\r\n            },\r\n            success: function(res) {\r\n                // If assistant returned structured automation\r\n                if (res.automation && res.data) {\r\n                    renderAutomationMessage(res.data);\r\n                    return;\r\n                }\r\n\r\n                // Otherwise handle plain text\r\n                if (res.reply) {\r\n                    // preserve line breaks\r\n                    const formattedReply = res.reply.replace(/\\n/g, '<br>');\r\n                    appendMessage(formattedReply, 'bot');\r\n                } else {\r\n                    appendMessage('⚠️ ' + (res.error || 'No response from AI'), 'bot');\r\n                }\r\n            },\r\n            error: function(xhr) {\r\n                appendMessage('❌ Failed to connect to server.', 'bot');\r\n                console.error(xhr);\r\n            }\r\n        });\r\n    }\r\n\r\n\r\n    function handleTabSwitch(newMode) {\r\n        if (newMode === currentMode) return;\r\n\r\n        currentMode = newMode;\r\n        console.log(`Switched to mode: ${currentMode}`);\r\n\r\n        // Update tab visuals\r\n        $('.chat-tab').removeClass('active');\r\n        $(`.chat-tab[data-mode=\"${currentMode}\"]`).addClass('active');\r\n\r\n        // Update header title\r\n        const headerText = {\r\n            assistant: 'AI Assistant',\r\n            qb: 'QB Generator',\r\n            quiz: 'Quiz Generator'\r\n        }[currentMode];\r\n        $('.chat-header span').text(headerText);\r\n\r\n        pendingCoursePayload = null;\r\n        awaitingConfirmation = false;\r\n\r\n        clearConfirmButton();\r\n\r\n        loadHistory();\r\n    }\r\n\r\n    function bindEvents() {\r\n        $('#ai-chatbot-button').on('click', () => {\r\n            $('#ai-chatbot-modal').toggleClass('hidden');\r\n            $('#chatbot-input').focus();\r\n        });\r\n\r\n        $('#chatbot-close-btn').on('click', () => {\r\n            $('#ai-chatbot-modal').addClass('hidden');\r\n        });\r\n\r\n        $('#chatbot-send-btn').on('click', handleSend);\r\n\r\n        $('#chatbot-input').on('keypress', function(e) {\r\n            if (e.key === 'Enter') {\r\n                e.preventDefault();\r\n                handleSend();\r\n            }\r\n        });\r\n\r\n        $('.chat-tab').on('click', function() {\r\n            const mode = $(this).data('mode');\r\n            handleTabSwitch(mode);\r\n        });\r\n    }\r\n\r\n    function init() {\r\n        if (!document.getElementById('chatbot-style')) {\r\n            $('head').append('<link id=\"chatbot-style\" rel=\"stylesheet\" href=\"'+M.cfg.wwwroot+'/local/automation/style/chatbot.css\">');\r\n        }\r\n        \r\n        Templates.render('local_automation/chatbot', {})\r\n            .then(html => {\r\n                $('body').append(html);\r\n                bindEvents();\r\n                loadHistory();\r\n            })\r\n            .catch(err => console.error(\"Chatbot template load failed:\", err));\r\n    }\r\n\r\n    return { init: init };\r\n});\r\n"],"names":["define","$","Templates","currentMode","pendingCoursePayload","awaitingConfirmation","getStorageKey","loadHistory","empty","history","localStorage","getItem","JSON","parse","forEach","msg","appendMessage","text","sender","scrollMessagesToBottom","saveMessage","push","setItem","stringify","store","className","append","msgBox","scrollTo","top","scrollHeight","behavior","renderAutomationMessage","data","type","missing","join","params","category","numsections","parseInt","isNaN","Array","isArray","sections","length","map","s","idx","name","title","i","slice","shortname","fullname","replace","toUpperCase","escapeHtml","onConfirm","console","log","M","cfg","wwwroot","sesskey","ajax","url","method","contentType","dataType","success","res","courseid","clearConfirmButton","error","xhr","html","off","on","str","String","handleSend","input","val","trim","promptToSend","prompt","mode","automation","reply","bindEvents","toggleClass","focus","addClass","e","key","preventDefault","newMode","removeClass","headerText","assistant","qb","quiz","handleTabSwitch","this","init","document","getElementById","render","then","catch","err"],"mappings":"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"}