define("local_automation/chat_quiz",["jquery","core/notification"],(function($,Notification){let selectedCourseId=null,selectedSectionId=null,fileMetaById={},selectedFileIds=[],currentSections=[],quizConfig={quizname:"",numquestions:10,marksperquestion:1,timelimitminutes:0},draftQuestions=[];function escapeHtml(str){return null==str?"":String(str).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function ensurePanel(){if($("#quiz-panel").length)return;$("#chatbot-messages").prepend('\n            <div id="quiz-panel" class="quiz-panel">\n                <div class="quiz-row">\n                    <label>Subject (course)</label>\n                    <select id="quiz-course-select">\n                        <option value="">Select course.</option>\n                        \x3c!-- Options loaded via AJAX --\x3e\n                    </select>\n                </div>\n\n                <div class="quiz-row">\n                    <label>Upload quiz to section</label>\n                    <select id="quiz-section-select">\n                        <option value="">Select section.</option>\n                        \x3c!-- Populated after course files are loaded --\x3e\n                    </select>\n                </div>\n\n                <div class="quiz-row">\n                    <label>Notes / PPTs / Docs to use as context</label>\n                    <div>\n                        <label>\n                            <input type="checkbox" id="quiz-use-all-resources">\n                            Select all supported files (PDF/PPT/Word)\n                        </label>\n                    </div>\n                    <div id="quiz-files-tree" class="quiz-files-tree">\n                        <div class="quiz-info">Select a course to load files.</div>\n                    </div>\n                </div>\n\n                <div class="quiz-row">\n                    <label>Quiz name</label>\n                    <input type="text" id="quiz-name-input" />\n                </div>\n\n                <div class="quiz-row quiz-three-cols">\n                    <div>\n                        <label>Number of MCQs</label>\n                        <input type="number" id="quiz-numquestions" min="1" value="10" />\n                    </div>\n                    <div>\n                        <label>Marks per question</label>\n                        <input type="number" id="quiz-marks" min="0" step="0.5" value="1" />\n                    </div>\n                    <div>\n                        <label>Time limit (minutes, 0 = none)</label>\n                        <input type="number" id="quiz-timelimit" min="0" value="0" />\n                    </div>\n                </div>\n\n                <div class="quiz-row quiz-hint">\n                    Type any extra instructions in the chat box below\n                    (e.g. "mix easy/medium questions", "focus on trees").\n                    Then click <b>Send</b> in Quiz mode to generate MCQs.\n                </div>\n\n                <div class="quiz-draft hidden">\n                    <h4>Draft questions</h4>\n                    <div class="quiz-draft-list"></div>\n                    <div class="quiz-actions">\n                        <button type="button" class="btn btn-secondary quiz-btn-upload">\n                            Upload quiz to course\n                        </button>\n                    </div>\n                </div>\n            </div>\n        '),applyQuizInlineStyles(),$("#quiz-course-select").on("change",(function(){const cid=$(this).val();selectedCourseId=cid?parseInt(cid,10):null,function(courseid){if(!courseid)return $("#quiz-files-tree").html('<div class="quiz-info">Select a course to load files.</div>'),$("#quiz-section-select").empty().append('<option value="">Select section.</option>'),fileMetaById={},selectedFileIds=[],currentSections=[],$("#quiz-use-all-resources").prop("checked",!1),void updateGenerateState();$.ajax({url:M.cfg.wwwroot+"/local/automation/qb_ajax.php",method:"POST",data:JSON.stringify({action:"fetch_files",courseid:courseid,sesskey:M.cfg.sesskey}),contentType:"application/json",dataType:"json",success:function(res){if(!res||!res.success)return console.error("Quiz fetch_files error:",res),$("#quiz-files-tree").html('<div class="quiz-info">No files found for this course.</div>'),fileMetaById={},selectedFileIds=[],currentSections=[],$("#quiz-section-select").empty().append('<option value="">Select section.</option>'),void updateGenerateState();currentSections=res.sections||[],function(sections){const $select=$("#quiz-section-select");$select.empty(),$select.append('<option value="">Select section.</option>'),sections.forEach((sec=>{const label=escapeHtml(sec.name||"Section "+sec.id);$select.append('<option value="'.concat(String(sec.id),'">').concat(label,"</option>"))}))}(currentSections),function(sections){if(fileMetaById={},selectedFileIds=[],$("#quiz-use-all-resources").prop("checked",!1),!sections.length)return $("#quiz-files-tree").html('<div class="quiz-info">No supported files (PDF/PPT/Word) found in this course.</div>'),void updateGenerateState();let html="";sections.forEach((section=>{const sname=escapeHtml(section.name||"Topic"),files=Array.isArray(section.files)?section.files:[];if(!files.length)return;const treeRoot=function(section,files){const root={type:"root",name:section.name||"Section",children:{}};return files.forEach((file=>{const fileid=file.fileid,name=file.name,path=file.path||name;fileMetaById[fileid]={name:name,path:path,sectionname:section.name||"",courseid:section.courseid||selectedCourseId};const parts=path.split("/").filter(Boolean);let node=root;for(let i=0;i<parts.length-1;i++){const folderName=parts[i];node.children[folderName]||(node.children[folderName]={type:"folder",name:folderName,children:{}}),node=node.children[folderName]}const filename=parts[parts.length-1]||name;node.children[filename]={type:"file",name:filename,fileid:fileid}})),root}(section,files);html+='\n                <div class="quiz-section">\n                    <div class="quiz-section-title">\n                        <span class="quiz-icon quiz-icon-section">üìö</span>\n                        '.concat(sname,'\n                    </div>\n                    <div class="quiz-section-tree">\n                        ').concat(renderTreeNode(treeRoot),"\n                    </div>\n                </div>\n            ")})),html||(html='<div class="quiz-info">No supported files (PDF/PPT/Word) found in this course.</div>'),$("#quiz-files-tree").html(html),updateGenerateState()}(currentSections)},error:function(xhr){console.error("Quiz fetch_files AJAX error:",xhr),$("#quiz-files-tree").html('<div class="quiz-info">Failed to load files.</div>'),fileMetaById={},selectedFileIds=[],currentSections=[],$("#quiz-section-select").empty().append('<option value="">Select section.</option>'),updateGenerateState()}})}(selectedCourseId),updateGenerateState()})),$("#quiz-section-select").on("change",(function(){const sid=$(this).val();selectedSectionId=sid?parseInt(sid,10):null,updateGenerateState()})),$("#quiz-use-all-resources").on("change",(function(){const checked=$(this).is(":checked");$(".quiz-file-checkbox").prop("checked",checked),recomputeSelectedFiles(),updateGenerateState()})),$("#chatbot-messages").on("change",".quiz-file-checkbox",(function(){recomputeSelectedFiles();const totalFiles=$(".quiz-file-checkbox").length,totalSelected=$(".quiz-file-checkbox:checked").length;$("#quiz-use-all-resources").prop("checked",totalFiles>0&&totalFiles===totalSelected),updateGenerateState()})),$("#quiz-name-input, #quiz-numquestions, #quiz-marks, #quiz-timelimit").on("input",(function(){updateGenerateState()})),$("#quiz-panel").on("click",".quiz-btn-upload",(function(){!function(){if(updateGenerateState(),!draftQuestions.length)return void Notification.alert("Quiz generator","No questions to upload. Generate questions first.","OK");if(!selectedCourseId||!selectedSectionId||!quizConfig.quizname)return void Notification.alert("Quiz generator","Course, section or quiz name missing.","OK");const cleaned=[];if($("#quiz-panel .quiz-draft-item").each((function(){const $item=$(this),idx=parseInt($item.attr("data-qindex"),10)||0,questiontext=$item.find(".quiz-q".concat(idx,"-text")).val().trim();if(!questiontext)return;const options=[];if($item.find(".quiz-q".concat(idx,"-opt")).each((function(){const text=$(this).val().trim();text&&options.push(text)})),options.length<2)return;const correctStr=$item.find('input[name="quiz-q'.concat(idx,'-correct"]:checked')).val(),correctIndex=void 0!==correctStr?parseInt(correctStr,10):0,feedback=$item.find(".quiz-q".concat(idx,"-feedback")).val().trim();cleaned.push({questiontext:questiontext,options:options,correct_index:isNaN(correctIndex)?0:correctIndex,feedback:feedback})})),!cleaned.length)return void Notification.alert("Quiz generator","No valid questions to upload.","OK");const payload={action:"upload",courseid:selectedCourseId,sectionid:selectedSectionId,quizname:quizConfig.quizname,marksperquestion:quizConfig.marksperquestion,timelimitminutes:quizConfig.timelimitminutes,questions:draftQuestions},$btn=$("#quiz-panel .quiz-btn-upload").prop("disabled",!0);$btn.text("Uploading..."),$.ajax({url:M.cfg.wwwroot+"/local/automation/quiz_ajax.php?sesskey="+M.cfg.sesskey,method:"POST",contentType:"application/json",dataType:"json",data:JSON.stringify(payload),success:function(res){if(!res||!res.success)return void Notification.alert("Quiz generator",res&&res.message?res.message:"Failed to create quiz.","OK");const msg="\n<p>".concat(escapeHtml(res.message||"Quiz created successfully."),'</p>\n<p>\n  <a href="').concat(escapeHtml(res.settingsurl||"#"),'" target="_blank">Open quiz settings</a><br/>\n  <a href="').concat(escapeHtml(res.editurl||"#"),'" target="_blank">Open question editor</a>\n</p>');Notification.alert("Quiz created",msg,"OK")},error:function(xhr){console.error("Quiz upload AJAX error:",xhr),Notification.alert("Quiz generator","AJAX error while creating quiz.","OK")},complete:function(){$btn.prop("disabled",!1).text("Upload quiz to course")}})}()})),updateGenerateState(),$.ajax({url:M.cfg.wwwroot+"/local/automation/qb_ajax.php",method:"POST",data:JSON.stringify({action:"fetch_courses",sesskey:M.cfg.sesskey}),contentType:"application/json",dataType:"json",success:function(res){res&&res.success?function(courses){const $select=$("#quiz-course-select");$select.empty(),$select.append('<option value="">Select course.</option>'),courses.forEach((c=>{const label=escapeHtml(c.fullname||c.shortname||"Course "+c.id);$select.append('<option value="'.concat(String(c.id),'">').concat(label,"</option>"))}))}(res.courses||[]):console.error("Quiz fetch_courses error:",res)},error:function(xhr){console.error("Quiz fetch_courses AJAX error:",xhr)}})}function applyQuizInlineStyles(){const $panel=$("#quiz-panel");$panel.css({border:"1px solid #ddd",borderRadius:"8px",padding:"8px 10px",marginBottom:"10px",background:"#f9fafb",fontSize:"0.85rem"}),$panel.find(".quiz-row").css({marginBottom:"8px"}),$panel.find("label").css({display:"block",fontWeight:"600",marginBottom:"3px"}),$panel.find('select, input[type="number"], input[type="text"], textarea').css({width:"100%",maxWidth:"100%",boxSizing:"border-box",padding:"4px 6px",fontSize:"0.85rem"}),$panel.find(".quiz-three-cols").css({display:"grid",gridTemplateColumns:"repeat(3, minmax(0, 1fr))",gap:"8px"}),$panel.find(".quiz-files-tree").css({maxHeight:"180px",overflowY:"auto",padding:"4px 6px",background:"#fff",border:"1px solid #e5e7eb",borderRadius:"4px",fontSize:"0.8rem"}),$panel.find(".quiz-draft").css({marginTop:"10px",paddingTop:"8px",borderTop:"1px solid #ddd"}),$panel.find(".quiz-draft-item").css({border:"1px solid #ddd",borderRadius:"6px",padding:"6px",marginBottom:"8px",background:"#ffffff"}),$panel.find(".quiz-draft-question textarea, .quiz-draft-feedback textarea").css({width:"100%",boxSizing:"border-box",fontSize:"0.8rem"}),$panel.find('.quiz-draft-option input[type="text"]').css({width:"80%",marginLeft:"4px",fontSize:"0.8rem"}),$panel.find(".quiz-hint").css({fontSize:"0.75rem",color:"#555"})}function updateGenerateState(){const courseVal=$("#quiz-course-select").val();selectedCourseId=courseVal?parseInt(courseVal,10):null;const sectionVal=$("#quiz-section-select").val();selectedSectionId=sectionVal?parseInt(sectionVal,10):null,quizConfig.quizname=$("#quiz-name-input").val().trim(),quizConfig.numquestions=parseInt($("#quiz-numquestions").val()||"0",10),quizConfig.marksperquestion=parseFloat($("#quiz-marks").val()||"1"),quizConfig.timelimitminutes=parseInt($("#quiz-timelimit").val()||"0",10);const hasCourse=!!selectedCourseId,hasSection=!!selectedSectionId,hasFiles=selectedFileIds.length>0,hasQuizName=quizConfig.quizname.length>0,hasNumQuestions=quizConfig.numquestions>0,enabled=hasCourse&&hasSection&&hasFiles&&hasQuizName&&hasNumQuestions;$("#chatbot-input").prop("disabled",!enabled),$("#chatbot-send-btn").prop("disabled",!enabled)}function renderTreeNode(node){if(!node||!node.children)return"";const keys=Object.keys(node.children);if(!keys.length)return"";let html='<div class="quiz-tree-level">';return keys.forEach((key=>{const child=node.children[key];if("folder"===child.type)html+='\n                    <details class="quiz-folder">\n                        <summary>\n                            <span class="quiz-icon quiz-icon-folder">üìÅ</span>\n                            '.concat(escapeHtml(child.name),"\n                        </summary>\n                        ").concat(renderTreeNode(child),"\n                    </details>\n                ");else if("file"===child.type){const fid=child.fileid,id="quiz-file-"+fid,labelText=escapeHtml(fileMetaById[fid].path||child.name);html+='\n                    <div class="quiz-file">\n                        <label for="'.concat(id,'">\n                            <input type="checkbox"\n                                id="').concat(id,'"\n                                class="quiz-file-checkbox"\n                                data-fileid="').concat(fid,'">\n                            <span class="quiz-icon quiz-icon-file">üìÑ</span>\n                            ').concat(labelText,"\n                        </label>\n                    </div>\n                ")}})),html+="</div>",html}function recomputeSelectedFiles(){selectedFileIds=[],$(".quiz-file-checkbox:checked").each((function(){const fileid=parseInt($(this).data("fileid"),10);isNaN(fileid)||selectedFileIds.push(fileid)}))}return{beforeSend:function(text){return text},handleResponse:function(res,ui){return!1},reset:function(){selectedCourseId=null,selectedSectionId=null,fileMetaById={},selectedFileIds=[],currentSections=[],quizConfig={quizname:"",numquestions:10,marksperquestion:1,timelimitminutes:0},draftQuestions=[],$("#quiz-panel").remove(),$("#chatbot-input").prop("disabled",!1),$("#chatbot-send-btn").prop("disabled",!1).text("Send")},onModeActivated:function(){ensurePanel(),$("#chatbot-send-btn").text("Send"),updateGenerateState()},generate:function(instructions,ui){if(updateGenerateState(),!selectedCourseId)return void ui.appendMessage("‚ö†Ô∏è Please select a course first.","bot");if(!selectedSectionId)return void ui.appendMessage("‚ö†Ô∏è Please choose a section where the quiz will be created.","bot");if(!selectedFileIds.length)return void ui.appendMessage("‚ö†Ô∏è Please select at least one file to use as context.","bot");if(!quizConfig.quizname)return void ui.appendMessage("‚ö†Ô∏è Please enter a quiz name.","bot");if(quizConfig.numquestions<=0)return void ui.appendMessage("‚ö†Ô∏è Number of MCQs must be greater than zero.","bot");$("#quiz-course-select").prop("disabled",!0),$("#quiz-section-select").prop("disabled",!0),$("#quiz-use-all-resources").prop("disabled",!0),$(".quiz-file-checkbox").prop("disabled",!0),$("#quiz-name-input").prop("disabled",!0),$("#quiz-numquestions").prop("disabled",!0),$("#quiz-marks").prop("disabled",!0),$("#quiz-timelimit").prop("disabled",!0),$("#chatbot-input").prop("disabled",!0),$("#chatbot-send-btn").prop("disabled",!0),$(".quiz-btn-generate-panel").prop("disabled",!0),ui.appendMessage("‚è≥ Generating MCQ questions for this quiz‚Ä¶","bot");const payload={action:"generate",courseid:selectedCourseId,sectionid:selectedSectionId,fileids:selectedFileIds,quizname:quizConfig.quizname,numquestions:quizConfig.numquestions,marksperquestion:quizConfig.marksperquestion,timelimitminutes:quizConfig.timelimitminutes,instructions:instructions||""};$.ajax({url:M.cfg.wwwroot+"/local/automation/quiz_ajax.php?sesskey="+M.cfg.sesskey,method:"POST",contentType:"application/json",dataType:"json",data:JSON.stringify(payload),success:function(res){res&&res.success?(draftQuestions=res.questions||[],function(){const $draft=$("#quiz-panel .quiz-draft"),$list=$draft.find(".quiz-draft-list");$list.empty(),draftQuestions.forEach(((q,index)=>{const opts=Array.isArray(q.options)?q.options:[],correct=parseInt(q.correct_index,10)||0,feedback=q.feedback||"",htmlOptions=opts.map(((opt,i)=>'\n                <div class="quiz-draft-option">\n                    <label>\n                        <input type="radio"\n                               name="quiz-q'.concat(index,'-correct"\n                               value="').concat(i,'" ').concat(i===correct?"checked":"",' />\n                        Correct\n                    </label>\n                    <input type="text"\n                           class="quiz-q').concat(index,'-opt"\n                           data-index="').concat(i,'"\n                           value="').concat(escapeHtml(opt),'" />\n                </div>\n            '))).join(""),block='\n                <div class="quiz-draft-item" data-qindex="'.concat(index,'">\n                    <div class="quiz-draft-question">\n                        <label>Question ').concat(index+1,'</label>\n                        <textarea class="quiz-q').concat(index,'-text" rows="3">').concat(escapeHtml(q.questiontext||""),'</textarea>\n                    </div>\n                    <div class="quiz-draft-options">\n                        ').concat(htmlOptions,'\n                    </div>\n                    <div class="quiz-draft-feedback">\n                        <label>Feedback (optional)</label>\n                        <textarea class="quiz-q').concat(index,'-feedback" rows="2">').concat(escapeHtml(feedback),"</textarea>\n                    </div>\n                </div>\n            ");$list.append(block)})),$draft.removeClass("hidden"),applyQuizInlineStyles()}()):Notification.alert("Quiz generator",res&&res.message?res.message:"Failed to generate questions.","OK")},error:function(xhr){console.error("Quiz generate AJAX error:",xhr),Notification.alert("Quiz generator","AJAX error while contacting server.","OK")},complete:function(){$("#quiz-course-select").prop("disabled",!1),$("#quiz-section-select").prop("disabled",!1),$("#quiz-use-all-resources").prop("disabled",!1),$(".quiz-file-checkbox").prop("disabled",!1),$("#quiz-name-input").prop("disabled",!1),$("#quiz-numquestions").prop("disabled",!1),$("#quiz-marks").prop("disabled",!1),$("#quiz-timelimit").prop("disabled",!1),$("#chatbot-input").prop("disabled",!1),$("#chatbot-send-btn").prop("disabled",!1)}})}}}));

//# sourceMappingURL=chat_quiz.min.js.map