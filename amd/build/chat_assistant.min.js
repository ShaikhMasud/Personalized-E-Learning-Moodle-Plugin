define("local_automation/chat_assistant",["jquery"],(function($){let pendingCoursePayload=null,awaitingConfirmation=!1;function reset(){pendingCoursePayload=null,awaitingConfirmation=!1}return{beforeSend:function(text){if(pendingCoursePayload&&awaitingConfirmation){return["You are updating an existing COURSE CREATION JSON.","Strict rules:","- You MUST respond with a single JSON object, no explanations.",'- "type" MUST be exactly "course_creation" (do NOT invent new types).',"- Preserve existing fields unless the user explicitly changes them.","- Keep the same number of sections (same array length).","- Only modify the specific sections or fields the user mentions.","- When the user gives new section names, COPY THEM VERBATIM.","- Do not change spelling, singular/plural, or wording of section names.","","PREVIOUS_PARAMS:",JSON.stringify(pendingCoursePayload),"","USER_EDIT:",text].join("\n")}return text},handleResponse:function(res,ui){if(!(res&&res.automation&&res.data))return!1;const data=res.data;if("course_creation_missing_params"===data.type){const missing=data.missing||[];return ui.appendMessage("<div><b>Missing parameters:</b> "+ui.escapeHtml(missing.join(", "))+"</div>","bot"),reset(),ui.clearConfirmButton(),!0}if("course_creation"===data.type||"course_update"===data.type){const params=data.params||{},category=params.category||1;let numsections=parseInt(params.numsections,10);(isNaN(numsections)||numsections<=0)&&(numsections=Array.isArray(params.sections)?params.sections.length:0);let sections=(Array.isArray(params.sections)?params.sections:[]).map(((s,idx)=>"string"==typeof s?s:s&&"object"==typeof s&&(s.name||s.title)||"Section "+(idx+1)));if(numsections>sections.length){for(let i=sections.length;i<numsections;i++)sections.push("Section "+(i+1))}numsections>0&&sections.length>numsections&&(sections=sections.slice(0,numsections));let shortname=params.shortname||"";!shortname&&params.fullname&&(shortname=params.fullname.replace(/\s+/g,"").toUpperCase().slice(0,15)),pendingCoursePayload={fullname:params.fullname||"",shortname:shortname,category:category,sections:sections},awaitingConfirmation=!0;const html='\n                <div class="automation-box">\n                    <b>Course Preview</b><br>\n                    Fullname: '.concat(ui.escapeHtml(pendingCoursePayload.fullname),"<br>\n                    Shortname: ").concat(ui.escapeHtml(pendingCoursePayload.shortname),"<br>\n                    Category: ").concat(ui.escapeHtml(String(pendingCoursePayload.category)),"<br>\n                    Sections: ").concat(ui.escapeHtml(pendingCoursePayload.sections.join(", ")),"<br>\n                </div>\n            ");return ui.appendMessage(html,"bot"),ui.showConfirmButton((function(){pendingCoursePayload?(console.log("JS DEBUG: Sending request to:",M.cfg.wwwroot+"/local/automation/course_ajax.php"),console.log("JS DEBUG: Payload being sent:",{...pendingCoursePayload,sesskey:M.cfg.sesskey}),$.ajax({url:M.cfg.wwwroot+"/local/automation/course_ajax.php",method:"POST",data:JSON.stringify({...pendingCoursePayload,sesskey:M.cfg.sesskey}),contentType:"application/json",dataType:"json",success:function(response){console.log("Server response:",response),response&&response.success?(ui.appendMessage("✅ Course created! ID: ".concat(ui.escapeHtml(String(response.courseid))),"bot"),reset(),ui.clearConfirmButton()):ui.appendMessage("❌ Error: "+(response.error||"Unknown error"),"bot")},error:function(xhr){ui.appendMessage("❌ Failed to create course. See server logs.","bot"),console.error("AJAX error (course_ajax):",xhr)}})):ui.appendMessage("⚠️ No course data to confirm.","bot")})),ui.scrollMessagesToBottom(),!0}return!1},reset:reset}}));

//# sourceMappingURL=chat_assistant.min.js.map