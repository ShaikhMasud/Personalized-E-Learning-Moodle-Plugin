define("local_automation/chatbot",["jquery","core/templates"],(function($,Templates){let currentMode="assistant",pendingCoursePayload=null,awaitingConfirmation=!1;function getStorageKey(){return"ai_chat_history_"+currentMode}function loadHistory(){$("#chatbot-messages").empty();let history=localStorage.getItem(getStorageKey());history&&(history=JSON.parse(history),history.forEach((msg=>appendMessage(msg.text,msg.sender,!1))),scrollMessagesToBottom())}function saveMessage(text,sender){let history=localStorage.getItem(getStorageKey());history=history?JSON.parse(history):[],history.push({text:text,sender:sender}),localStorage.setItem(getStorageKey(),JSON.stringify(history))}function appendMessage(text,sender){let store=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];const className="user"===sender?"msg-user":"msg-bot";$("#chatbot-messages").append('<div class="message '.concat(className,'">').concat(text,"</div>")),store&&saveMessage(text,sender),scrollMessagesToBottom()}function scrollMessagesToBottom(){const msgBox=$("#chatbot-messages")[0];msgBox&&msgBox.scrollTo({top:msgBox.scrollHeight,behavior:"smooth"})}function renderAutomationMessage(data){if("course_creation_missing_params"===data.type){const missing=data.missing||[];return appendMessage("<div><b>Missing parameters:</b> ".concat(missing.join(", "),"</div>"),"bot"),pendingCoursePayload=null,void(awaitingConfirmation=!1)}if("course_creation"===data.type||"course_update"===data.type){const params=data.params||{},category=params.category||1;let numsections=parseInt(params.numsections,10);(isNaN(numsections)||numsections<=0)&&(numsections=Array.isArray(params.sections)?params.sections.length:0);let sections=(Array.isArray(params.sections)?params.sections:[]).map(((s,idx)=>"string"==typeof s?s:s&&"object"==typeof s&&(s.name||s.title)||"Section "+(idx+1)));if(numsections>sections.length){for(let i=sections.length;i<numsections;i++)sections.push("Section "+(i+1))}numsections>0&&sections.length>numsections&&(sections=sections.slice(0,numsections));let shortname=params.shortname||"";!shortname&&params.fullname&&(shortname=params.fullname.replace(/\s+/g,"").toUpperCase().slice(0,15)),pendingCoursePayload={fullname:params.fullname||"",shortname:params.shortname||"",category:category,sections:sections},awaitingConfirmation=!0;return appendMessage('\n                <div class="automation-box">\n                    <b>Course Preview</b><br>\n                    Fullname: '.concat(escapeHtml(pendingCoursePayload.fullname),"<br>\n                    Shortname: ").concat(escapeHtml(pendingCoursePayload.shortname),"<br>\n                    Category: ").concat(escapeHtml(pendingCoursePayload.category),"<br>\n                    Sections: ").concat(escapeHtml(pendingCoursePayload.sections.join(", ")),"<br>\n                </div>\n            "),"bot"),onConfirm=function(){console.log("JS DEBUG: Sending request to:",M.cfg.wwwroot+"/local/automation/course_ajax.php"),console.log("JS DEBUG: Payload being sent:",{...pendingCoursePayload,sesskey:M.cfg.sesskey}),$.ajax({url:M.cfg.wwwroot+"/local/automation/course_ajax.php",method:"POST",data:JSON.stringify({...pendingCoursePayload,sesskey:M.cfg.sesskey}),contentType:"application/json",dataType:"json",success:function(res){console.log("Server response:",res),res&&res.success?(appendMessage("✅ Course created! ID: ".concat(res.courseid),"bot"),pendingCoursePayload=null,awaitingConfirmation=!1,clearConfirmButton()):appendMessage("❌ Error: "+(res.error||"Unknown error"),"bot")},error:function(xhr){appendMessage("❌ Failed to create course. See server logs.","bot"),console.error("AJAX error:",xhr)}})},$("#chatbot-action-area").html('\n            <div id="chatbot-edit-note">Type for any edits...</div>\n            <button id="chatbot-confirm-btn">Confirm</button>\n        '),$("#chatbot-confirm-btn").off("click").on("click",onConfirm),void scrollMessagesToBottom()}var onConfirm;appendMessage("<pre>".concat(escapeHtml(JSON.stringify(data,null,2)),"</pre>"),"bot")}function escapeHtml(str){return null==str?"":String(str).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function clearConfirmButton(){$("#chatbot-action-area").empty()}function handleSend(){const input=$("#chatbot-input"),text=input.val().trim();if(!text)return;appendMessage(text,"user"),input.val("");let promptToSend=text;if(pendingCoursePayload&&awaitingConfirmation){promptToSend=["You are updating an existing COURSE CREATION JSON.","Strict rules:","- You MUST respond with a single JSON object, no explanations.",'- "type" MUST be exactly "course_creation" (do NOT invent new types).',"- Preserve existing fields unless the user explicitly changes them.","- Keep the same number of sections (same array length).","- Only modify the specific sections or fields the user mentions.","","PREVIOUS_PARAMS:",JSON.stringify(pendingCoursePayload),"","USER_EDIT:",text].join("\n")}$.ajax({url:M.cfg.wwwroot+"/local/automation/chatbot_endpoint.php",method:"POST",data:{prompt:promptToSend,mode:currentMode,sesskey:M.cfg.sesskey},success:function(res){if(res.automation&&res.data)renderAutomationMessage(res.data);else if(res.reply){appendMessage(res.reply.replace(/\n/g,"<br>"),"bot")}else appendMessage("⚠️ "+(res.error||"No response from AI"),"bot")},error:function(xhr){appendMessage("❌ Failed to connect to server.","bot"),console.error(xhr)}})}function bindEvents(){$("#ai-chatbot-button").on("click",(()=>{$("#ai-chatbot-modal").toggleClass("hidden"),$("#chatbot-input").focus()})),$("#chatbot-close-btn").on("click",(()=>{$("#ai-chatbot-modal").addClass("hidden")})),$("#chatbot-send-btn").on("click",handleSend),$("#chatbot-input").on("keypress",(function(e){"Enter"===e.key&&(e.preventDefault(),handleSend())})),$(".chat-tab").on("click",(function(){!function(newMode){if(newMode===currentMode)return;currentMode=newMode,console.log("Switched to mode: ".concat(currentMode)),$(".chat-tab").removeClass("active"),$('.chat-tab[data-mode="'.concat(currentMode,'"]')).addClass("active");const headerText={assistant:"AI Assistant",qb:"QB Generator",quiz:"Quiz Generator"}[currentMode];$(".chat-header span").text(headerText),pendingCoursePayload=null,awaitingConfirmation=!1,clearConfirmButton(),loadHistory()}($(this).data("mode"))}))}return{init:function(){document.getElementById("chatbot-style")||$("head").append('<link id="chatbot-style" rel="stylesheet" href="'+M.cfg.wwwroot+'/local/automation/style/chatbot.css">'),Templates.render("local_automation/chatbot",{}).then((html=>{$("body").append(html),bindEvents(),loadHistory()})).catch((err=>console.error("Chatbot template load failed:",err)))}}}));

//# sourceMappingURL=chatbot.min.js.map